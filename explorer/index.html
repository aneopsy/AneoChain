<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8 />
    <title>EvoExplorer</title>

    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">

    <link rel="stylesheet" href="vendor/source-sans-pro/source-sans-pro.css">
    <link rel="stylesheet" href="style/fira.css">
    <link rel="stylesheet" href="style/style.css">

    <script type="text/javascript" src="../dist/Evo.js"></script>
    <script src="assets/script.min.js"></script>
    <script src="assets/evo.js"></script>
</head>
<body>
    <header>
        <h1>
            <a href="#" onclick="_linkClicked(this, true);" >
                <span class="Evo-logo">
                    <!-- <svg fill="#e34a45" xmlns="http://www.w3.org/2000/svg" width="34" height="30"><path d="M25.2 1H8.8l-8 14 8 14h16.4l8-14-8-14zm-6.7 22V26H16v-2.6c-1.5 0-3.3-.8-4.5-2l1.7-2.4c1.3 1 2.4 1.5 3.6 1.5 1.4 0 2-.6 2-1.7 0-2.6-6.7-2.6-6.7-7 0-2.6 1.6-4.3 4-4.8V4.2h2.5v2.6c1.6.2 2.8 1 3.8 2l-2 2.2c-.8-1-1.6-1.3-2.7-1.3-1.2 0-2 .5-2 1.6.2 2.4 7 2.2 7 7 0 2.4-1.5 4.3-4 4.8z"></path></svg> -->
                </span>
                <img class="logo" src="assets/images/Evolve_trans.png"></img>
                EvoExplorer
            </a>
        </h1>
        <a href="#search" onclick="_linkClicked(this, true);" id="search">Search</a>
        <div class="submenu-container">
            <a href="#charts" onclick="_linkClicked(this, true);" id="charts">Charts</a>

            <div class="submenu">
                <a href="#chart-wealth-distribution" onclick="_linkClicked(this);">Wealth Distribution</a>
                <a href="#chart-global-hashrate" onclick="_linkClicked(this);">Global Hashrate</a>
                <a href="#chart-transactions-per-block" onclick="_linkClicked(this);">Transactions</a>
                <a href="#chart-hashing-distribution" onclick="_linkClicked(this);">Hashing Distribution</a>
            </div>
        </div>
        <a href="#about" onclick="_linkClicked(this, true);" id="about">What is this?</a>
        <span id="monitor" title="Connected to 0 peers">
            <strong>Status:</strong>
            <span id="status" class="not-connected">connecting</span> @ <span id="height"><em>loading</em></span><span id="syncPercentage"></span>
        </span>
    </header>

    <div id="searchbox">
        <h1>Search accounts and blocks:</h1>

        <form action="#search" method="GET" id="search-form">
            <input type="text" id="search-input" placeholder="account address, HEX block hash or block height" onfocus="this.select();" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
            <input type="submit" id="search-submit" value="go" disabled="" title="Consensus not established">
            <span class="detection">Format detected: <span id="hash-format"><em>none</em></span></span>
        </form>
    </div>

    <div id="infobox">
    </div>

    <div id="blocklist-wrapper">
        <h2>Latest blocks</h2>
        <div id="blocklist">
            <div class="blocklist-block">
                <div class="blocklist-cell">
                    <div class="blocklist-loader">
                        <!-- <svg fill="#e34a45" xmlns="http://www.w3.org/2000/svg" width="34" height="30"><path d="M25.2 1H8.8l-8 14 8 14h16.4l8-14-8-14zm-6.7 22V26H16v-2.6c-1.5 0-3.3-.8-4.5-2l1.7-2.4c1.3 1 2.4 1.5 3.6 1.5 1.4 0 2-.6 2-1.7 0-2.6-6.7-2.6-6.7-7 0-2.6 1.6-4.3 4-4.8V4.2h2.5v2.6c1.6.2 2.8 1 3.8 2l-2 2.2c-.8-1-1.6-1.3-2.7-1.3-1.2 0-2 .5-2 1.6.2 2.4 7 2.2 7 7 0 2.4-1.5 4.3-4 4.8z"></path></svg> -->
                        <img class="logo" src="assets/images/Evolve_trans.png"></img>
                    </div>
                    <p class="blocklist-loader-text">Please wait while the blockchain is being synchronized. You can track the progress in the top right corner of the screen.</p>
                </div>
            </div>
        </div>
    </div>

    <footer>
        This web application is built on top of the <a target="_blank" href="https://aneopsy.xyz">Evo Blockchain</a>.
        <a target="_blank" href="https://github.com/aneopsy/EvoCoin">View Source Code on Github.</a>
    </footer>

    <script type="text/x-tmpl" id="template-block-info">
        <h2>Block Info</h2>
        <div class="blockinfo-header">
            <div class="height">
                <h3>Height</h3>
                <span>#{%=o.height%}</span>
                <div>
                    <a href="#{%=o.height + 1%}">&#9650;</a>
                    <a href="#{%=o.height - 1%}">&#9660;</a>
                </div>
            </div>
            <div class="hash">
                <h3>Hash</h3>
                <hash>{%=o.hash%}</hash>
            </div>
        </div>
        <div class="blockinfo-body">
            <div class="blockinfo-body-left">
                <div class="blockinfo-body-row">
                    <label>Transactions </label>
                    <span>{%=o.transactionCount%}</span>
                </div>
                <div class="blockinfo-body-row">
                    <label>Transaction Value </label>
                    <span><img src="icons/evo_blue.svg"> {%=_formatBalance(Evo.Policy.satoshisToCoins(o.transactionValue))%}</span>
                </div>
                <div class="blockinfo-body-row">
                    <label>Difficulty </label>
                    <span>{%=(Math.round(o.difficulty * 100) / 100)%}</span>
                </div>
            </div>
            <div class="blockinfo-body-right">
                <div class="blockinfo-body-row">
                    <label>Timestamp </label>
                    <span>{% var date = new Date(o.timestamp * 1000); print(date.toLocaleString()); %}</span>
                </div>
                <div class="blockinfo-body-row">
                    <label>Size </label>
                    <span>{%=o.serializedSize%} Bytes</span>
                </div>
                <div class="blockinfo-body-row">
                    <label>Nonce </label>
                    <span>{%=o.nonce%}</span>
                </div>
            </div>
            <div class="blockinfo-miner">
                <label>Mined by </label>
                <hash><a href="#{%=o.minerAddr%}" onclick="_linkClicked(this);">{%=o.minerAddr%}</a></hash>
                <!--
                <label>Previous Block </label>
                <hash>{%=o.prevHash%}</hash>
                -->
            </div>
        </div>
        <div class="blockinfo-transactions">
            {% if(o.transactionCount) { %}
                <div class="blockinfo-transaction-header-row">
                    <h3>Sender</h3>
                    <h3>Receiver</h3>
                    <h3>Value</h3>
                </div>
                {% for(var i = 0; i < o.transactions.length; i++) { %}
                    <div class="blockinfo-transaction-row">
                        <hash id="{% var elementId = 'sender-address-' + i; _getAndWriteSenderAddressHash(o.transactions[i], elementId); print(elementId); %}"></hash>
                        <hash><a href="#{%=o.transactions[i].recipientAddr.toHex()%}" onclick="_linkClicked(this);">{%=o.transactions[i].recipientAddr.toHex()%}</a></hash>
                        <span><img src="icons/evo_blue.svg"> {%=_formatBalance(Evo.Policy.satoshisToCoins(o.transactions[i].value))%}</span>
                    </div>
                {% } %}
            {% } else { %}
                <div class="no-transactions">No transactions</div>
            {% } %}
        </div>
    </script>

    <script type="text/x-tmpl" id="template-account-info">
        <div class="accountinfo-wrapper">
            <h2>Account Info</h2>
            <div class="blockinfo-header">
                <div class="hash">
                    <h3>Address</h3>
                    <hash>{%=o.hash%}</hash>
                </div>
            </div>
            <div class="blockinfo-body">
                <div class="blockinfo-body-row">
                    <label>Balance </label>
                    <span><img src="icons/evo_blue.svg"> {%=_formatBalance(Evo.Policy.satoshisToCoins(o.balance))%}</span>
                </div>
                <div class="blockinfo-body-row">
                    <label>Nonce </label>
                    <span>{%=o.nonce%}</span>
                </div>
            </div>
        </div>
    </script>

    <script type="text/x-tmpl" id="template-blocklist-block">
        <a href="#{%=o.height%}" class="blocklist-cell" onclick="_linkClicked(this);">
            #{%=o.height%}
        </a>
        <div class="blocklist-cell">
            {% var time = new Date(o.timestamp * 1000); print(time.toLocaleTimeString()); %}
        </div>
        <div class="blocklist-cell">
            {%=o.transactionCount%} {% if(o.transactionCount === 1) print('transaction'); else print('transactions'); %}
        </div>
        <div class="blocklist-cell ellipsis">
            found by <hash><a href="#{%=o.minerAddr%}" onclick="_linkClicked(this);">{%=o.minerAddr%}</a></hash>
        </div>
        <div class="blocklist-cell">
            {%=o.serializedSize%} Bytes
        </div>
    </script>

    <script type="text/x-tmpl" id="template-about">
        <div class="about-wrapper">
            <h2>What is this?</h2>
            <p>
                This website is a blockchain explorer for the new <a href="https://aneopsy.xyz" target="_blank">Evo blockchain project</a>.
            </p>
            <p>
                Because the Evo blockchain lives in your browser, this website works without a server. All necessary information is
                present in the blockchain, loaded in this browser.
            </p>
            <p>
                The source code for this website is open source and available at
                <a href="https://github.com/aneopsy/EvoCoin" target="_blank">https://github.com/aneopsy/EvoCoin</a>.
            </p>
            <p>
                To learn more about the Evo blockchain, visit the
                <a href="https://aneopsy.xyz"                            target="_blank">homepage</a>,
            </p>
        </div>
    </script>

    <script type="text/x-tmpl" id="template-charts">
        <div class="charts-wrapper">
            <h2>Charts</h2>
            <p>
                <a href="#chart-wealth-distribution">Wealth Distribution</a>
                <a href="#chart-global-hashrate">Global Hashrate</a>
                <a href="#chart-transactions-per-block">Transactions</a>
                <a href="#chart-hashing-distribution">Hashing Distribution</a>
            </p>
        </div>
    </script>

    <script type="text/x-tmpl" id="template-wealth-distribution-chart">
        <div class="axis-type-switch">
            <label class="switch-light switch-candy" onclick="">
                <input type="checkbox" onchange="_wealthDistributionSwitchScale(this);" disabled="">
                <span>
                    <span>Linear</span>
                    <span>Logarithmic</span>
                    <a></a>
                </span>
            </label>
        </div>
        <h2>Wealth Distribution</h2>
        <small>Among non-zero accounts</small>
        <canvas class="chart"></canvas>
        <div class="blocklist-loader over-canvas">
            <svg fill="#e34a45" xmlns="http://www.w3.org/2000/svg" width="34" height="30"><path d="M25.2 1H8.8l-8 14 8 14h16.4l8-14-8-14zm-6.7 22V26H16v-2.6c-1.5 0-3.3-.8-4.5-2l1.7-2.4c1.3 1 2.4 1.5 3.6 1.5 1.4 0 2-.6 2-1.7 0-2.6-6.7-2.6-6.7-7 0-2.6 1.6-4.3 4-4.8V4.2h2.5v2.6c1.6.2 2.8 1 3.8 2l-2 2.2c-.8-1-1.6-1.3-2.7-1.3-1.2 0-2 .5-2 1.6.2 2.4 7 2.2 7 7 0 2.4-1.5 4.3-4 4.8z"></path></svg>
        </div>
        <div class="chart-valid-info"></div>
    </script>

    <script type="text/x-tmpl" id="template-global-hashrate-chart">
        <h2>Global Hashrate</h2>
        <small>During the last 24 hours</small>
        <canvas class="chart"></canvas>
        <div class="blocklist-loader over-canvas">
            <svg fill="#e34a45" xmlns="http://www.w3.org/2000/svg" width="34" height="30"><path d="M25.2 1H8.8l-8 14 8 14h16.4l8-14-8-14zm-6.7 22V26H16v-2.6c-1.5 0-3.3-.8-4.5-2l1.7-2.4c1.3 1 2.4 1.5 3.6 1.5 1.4 0 2-.6 2-1.7 0-2.6-6.7-2.6-6.7-7 0-2.6 1.6-4.3 4-4.8V4.2h2.5v2.6c1.6.2 2.8 1 3.8 2l-2 2.2c-.8-1-1.6-1.3-2.7-1.3-1.2 0-2 .5-2 1.6.2 2.4 7 2.2 7 7 0 2.4-1.5 4.3-4 4.8z"></path></svg>
        </div>
        <div class="chart-valid-info"></div>
        <p><small><strong>Disclaimer:</strong> The global hashrate is estimated every 10 blocks by how fast the last 10 blocks have been mined.
        This time is measured from the timestamps of the blocks. Since the betanet does not yet include time synchronization, each block is timestamped with
        the local system time of the miner. These times can be different from the real time, thus skewing the global hashrate estimation.</small></p>
    </script>

    <script type="text/x-tmpl" id="template-transactions-per-block-chart">
        <h2>Transactions</h2>
        <small>During the last 24 hours</small>
        <canvas class="chart"></canvas>
        <div class="blocklist-loader over-canvas">
            <svg fill="#e34a45" xmlns="http://www.w3.org/2000/svg" width="34" height="30"><path d="M25.2 1H8.8l-8 14 8 14h16.4l8-14-8-14zm-6.7 22V26H16v-2.6c-1.5 0-3.3-.8-4.5-2l1.7-2.4c1.3 1 2.4 1.5 3.6 1.5 1.4 0 2-.6 2-1.7 0-2.6-6.7-2.6-6.7-7 0-2.6 1.6-4.3 4-4.8V4.2h2.5v2.6c1.6.2 2.8 1 3.8 2l-2 2.2c-.8-1-1.6-1.3-2.7-1.3-1.2 0-2 .5-2 1.6.2 2.4 7 2.2 7 7 0 2.4-1.5 4.3-4 4.8z"></path></svg>
        </div>
        <div class="chart-valid-info"></div>
    </script>

    <script type="text/x-tmpl" id="template-hashing-distribution-chart">
        <h2>Hashing Distribution</h2>
        <div class="hashing-distribution-chart-wrapper">
            <canvas class="chart"></canvas>
            <div class="blocklist-loader over-canvas">
                <svg fill="#e34a45" xmlns="http://www.w3.org/2000/svg" width="34" height="30"><path d="M25.2 1H8.8l-8 14 8 14h16.4l8-14-8-14zm-6.7 22V26H16v-2.6c-1.5 0-3.3-.8-4.5-2l1.7-2.4c1.3 1 2.4 1.5 3.6 1.5 1.4 0 2-.6 2-1.7 0-2.6-6.7-2.6-6.7-7 0-2.6 1.6-4.3 4-4.8V4.2h2.5v2.6c1.6.2 2.8 1 3.8 2l-2 2.2c-.8-1-1.6-1.3-2.7-1.3-1.2 0-2 .5-2 1.6.2 2.4 7 2.2 7 7 0 2.4-1.5 4.3-4 4.8z"></path></svg>
            </div>
        </div>

        <div class="hashing-distribution-chart-wrapper">
            <canvas class="chart"></canvas>
        </div>

        <div class="hashing-distribution-chart-wrapper" style="clear: left;">
            <canvas class="chart"></canvas>
        </div>

        <div class="hashing-distribution-chart-wrapper">
            <canvas class="chart"></canvas>
        </div>

        <div class="chart-valid-info"></div>
    </script>

    <script>
        var accountHashRegExp = new RegExp('^[A-Fa-f0-9]{40}$'),
            blockHashRegExp   = new RegExp('^[A-Fa-f0-9]{64}$');

        var tmpl = {
            blocklistBlock:            tmpl('template-blocklist-block'),
            blockInfo:                 tmpl('template-block-info'),
            accountInfo:               tmpl('template-account-info'),
            about:                     tmpl('template-about'),
            charts:                    tmpl('template-charts'),
            wealthDistributionChart:   tmpl('template-wealth-distribution-chart'),
            globalHashrateChart:       tmpl('template-global-hashrate-chart'),
            transactionsPerBlockChart: tmpl('template-transactions-per-block-chart'),
            hashingDistributionChart:  tmpl('template-hashing-distribution-chart')
        };

        var $infobox        = document.getElementById('infobox'),
            $searchInput    = document.getElementById('search-input'),
            $status         = document.getElementById('status'),
            $height         = document.getElementById('height'),
            $syncPercentage = document.getElementById('syncPercentage');

        var directNavigationTargets = ['#search', '#charts', '#about'];
        var syncTargetHeight = 0,
            syncStartHeight  = 0;

        var default_colors = ['#3366CC','#DC3912','#FF9900','#109618','#990099','#3B3EAC','#0099C6','#DD4477','#66AA00','#B82E2E','#316395','#994499','#22AA99','#AAAA11','#6633CC','#E67300','#8B0707','#329262','#5574A6','#3B3EAC'];
        default_colors = default_colors.concat(default_colors, default_colors);

        function _detectHashFormat(value) {
            if(accountHashRegExp.test(value)) {
                return "Account Address";
            }
            else if(blockHashRegExp.test(value) && value[0] === "0" && value[1] === "0") {
                return "Block Hash";
            }
            else if(value.match(/^[0-9]*$/) && parseInt(value)) {
                return "Block Number";
            }
        }

        function _formatBalance(value) {
            // If the value has no decimal places below 0.01, display 0 decimals
            if(parseFloat(value.toFixed(2)) === value) {
                return value.toFixed(2);
            }
            // Otherwise, all required decimals will be displayed automatically
            else return value;
        }

        function _getBlockInfo(hash, callback) {
            if(typeof hash === "string") {
                hash = Evo.Hash.fromHex(hash);
            }

            $.blockchain.getBlock(hash).then(function(block) {
                if(!block) {
                    callback(null);
                    return;
                }

                callback({
                    hash:             hash.toHex(),
                    height:           block.height,
                    timestamp:        block.timestamp,
                    difficulty:       block.difficulty,
                    serializedSize:   block.serializedSize,
                    minerAddr:        block.minerAddr.toHex(),
                    transactionCount: block.transactionCount,
                    transactions:     block.transactions,
                    transactionValue: block.transactions.reduce(function(acc, tx) { return tx.value + acc; }, 0),
                    prevHash:         block.prevHash.toHex(),
                    nonce:            block.nonce
                });
            });
        }

        function _getAndWriteSenderAddressHash(tx, elementId) {
            tx.getSenderAddr().then(function(address) {
                document.getElementById(elementId).innerHTML = '<a href="#' + address.toHex() + '" onclick="_linkClicked(this);">' + address.toHex() + '</a>';
            });
        }

        var blocklistBuilt = false;
        var latestBlocks = [];

        function _buildListOfLatestBlocks() {
            if(blocklistBuilt !== false) return;
            blocklistBuilt = null;

            var _accumulateBlocks = function(blockInfo) {
                latestBlocks.push(blockInfo);

                if(latestBlocks.length === 20) {
                    latestBlocks.sort(function(a, b) {
                        if(a.height < b.height) return -1;
                        else return 1;
                    });

                    blocklistNode.removeChild(blocklistNode.getElementsByTagName('div')[0]);

                    for(var i = 0; i < latestBlocks.length; i++ ) {
                        _addBlockToListOfLatestBlocks(latestBlocks[i]);
                    }

                    latestBlocks = null;
                    blocklistBuilt = true;
                }
            };

            var hashes = $.blockchain.path.slice(-20);

            // Query all blocks' info
            for(var i = 0; i < hashes.length; i++) {
                _getBlockInfo(hashes[i], _accumulateBlocks);
            }
        }

        var blocklistNode = document.getElementById('blocklist');

        function _addBlockToListOfLatestBlocks(blockInfo) {
            var item = document.createElement('div');
            item.classList.add('blocklist-block');

            item.innerHTML = tmpl.blocklistBlock(blockInfo);

            blocklistNode.insertBefore(item, blocklistNode.firstChild);
        }

        function _onHashChange(e) {
            var value = window.location.hash;

            // Remove leading '#'
            if(value[0] === "#") value = value.substring(1);

            if(value === "" || value === "search") {
                // Display homepage
                $infobox.innerText = "";
                $searchInput.value = "";
                $searchInput.focus();
                window.scrollTo(0, 0);
            }
            else if(value === "about") {
                $infobox.innerHTML = tmpl.about();
                window.scrollTo(0, $infobox.offsetTop - 100);
            }
            else if(value === "charts") {
                $infobox.innerHTML = tmpl.charts();
                window.scrollTo(0, $infobox.offsetTop - 100);
            }
            else if(value === "chart-wealth-distribution") {
                _wealthDistribution();
            }
            else if(value === "chart-global-hashrate") {
                _globalHashrate();
            }
            else if(value === "chart-transactions-per-block") {
                _transactionsPerBlock();
            }
            else if(value === "chart-hashing-distribution") {
                _hashingDistribution();
            }
            else {
                var format = _detectHashFormat(value);

                $searchInput.value = value;

                switch(format) {
                    case "Account Address":
                        $.accounts.getBalance(Evo.Address.fromHex(value)).then(function(balance) {
                            var accountInfo = {
                                hash: value,
                                balance: balance.value,
                                nonce: balance.nonce
                            };

                            $infobox.innerHTML = tmpl.accountInfo(accountInfo);
                            window.scrollTo(0, $infobox.offsetTop - 100);
                        });
                        break;
                    case "Block Hash":
                        _getBlockInfo(value, function(blockInfo) {
                            if(!blockInfo) {
                                alert("That block cannot be found. It my be out of reach due to the temporary checkpoint solution. Lowest possible block: " + $.blockchain.path[0].toHex());
                                return;
                            }

                            $infobox.innerHTML = tmpl.blockInfo(blockInfo);
                            window.scrollTo(0, $infobox.offsetTop - 100);
                        });
                        break;
                    case "Block Number":
                        var currentHeight = $.blockchain.head.height;
                        var pathIndex     = value - currentHeight - 1; // Should be a negative number

                        if(pathIndex < -$.blockchain.path.length) {
                            alert("That block is out of reach due to the temporary checkpoint solution. Lowest possible block: " + $.blockchain.path[0].toHex());
                            return;
                        }
                        if(pathIndex > -1) {
                            alert("That block has not been mined yet.");
                            return;
                        }

                        var blockHash = $.blockchain.path.slice(pathIndex)[0];

                        _getBlockInfo(blockHash, function(blockInfo) {
                            if(!blockInfo) {
                                alert("Cannot find block.");
                                return;
                            }
                            // console.log(blockInfo);

                            $infobox.innerHTML = tmpl.blockInfo(blockInfo);
                            window.scrollTo(0, $infobox.offsetTop - 100);
                        });
                        break;
                    default:
                        alert("Format cannot be detected.");
                }
            }
        }

        $searchInput.addEventListener('input', function(e) {
            document.getElementById('hash-format').innerHTML = _detectHashFormat(this.value) || "<em>none</em>";
        });

        document.getElementById('search-form').addEventListener('submit', function(e) {
            e.preventDefault();

            if(!$.consensus.established) return;

            var value = $searchInput.value;

            if(window.location.hash === "#" + value) {
                // The hashchange event does not trigger if the hash does not change
                // Thus we manually trigger the function
                window.onhashchange();
            }

            window.location.hash = "#" + value;
        });

        function _linkClicked(self, skipReadyCheck) {
            if(!$.consensus.established) {
                if(!skipReadyCheck) {
                    return;
                }
                else {
                    window.location.hash = self.hash;
                    _onHashChange();
                    return;
                }
            }

            if(window.location.hash === self.hash) {
                console.log("_linkClicked triggered");
                _onHashChange();
            }
        }

        $searchInput.focus();
        if(directNavigationTargets.indexOf(window.location.hash) > -1) _onHashChange();
    </script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-101611099-1', 'auto');
        ga('send', 'pageview');
    </script>

    <script>
        async function _wealthDistribution(axisType = "linear", skipRender = false) {
            if(!document.getElementById('toggle-switch-css-link')) {
                if(document.createStyleSheet) {
                    document.createStyleSheet("https://cdn.jsdelivr.net/css-toggle-switch/latest/toggle-switch.css");
                }
                else {
                    var linkTag = document.createElement('link');
                    linkTag.rel = "stylesheet";
                    linkTag.href = "https://cdn.jsdelivr.net/css-toggle-switch/latest/toggle-switch.css";
                    linkTag.id = "toggle-switch-css-link";
                    document.head.appendChild(linkTag);
                }
            }

            if(!skipRender) {
                // Only replace infobox contents when not coming from the scale toggle
                $infobox.innerHTML = tmpl.wealthDistributionChart();
                window.scrollTo(0, $infobox.offsetTop - 100);
            }

            var rootKey  = await $.accounts._tree._store.getRootKey();
            var rootNode = await $.accounts._tree._store.get(rootKey);

            var balances = [];

            await _resolveAccountsTreeNode(rootNode, "", balances);

            balances = balances.filter(balance => balance);
            balances.sort((a, b) => a > b ? -1 : a < b ? 1 : 0);

            balances = balances.map(balance => Evo.Policy.satoshisToCoins(balance));

            var _renderWealthDisributionChart = function() {
                var labels = [];
                for (var i = 1; i <= balances.length; i++) { labels.push(i); }
                labels = labels.map(label => label + '.');

                try {
                    $infobox.removeChild($infobox.getElementsByClassName('blocklist-loader')[0]);
                }
                catch(e) {}

                var time = new Date($.blockchain.head.timestamp * 1000);
                $infobox.getElementsByClassName('chart-valid-info')[0].innerHTML = "Created at block #" + $.blockchain.head.height + " - " + time.toLocaleString()

                if(window.chart) window.chart.destroy();
                if(window.chart2) window.chart2.destroy();
                if(window.chart3) window.chart3.destroy();
                if(window.chart4) window.chart4.destroy();

                var ctx = $infobox.getElementsByTagName('canvas')[0].getContext('2d');

                window.chart = new Chart(ctx, {
                    // The type of chart we want to create
                    type: 'line',

                    // The data for our dataset
                    data: {
                        labels: labels,
                        datasets: [{
                            label: "EvoCoin",
                            pointBackgroundColor: '#042146',
                            borderColor: '#042146',
                            data: balances
                        }]
                    },

                    // Configuration options go here
                    options: {
                        animation: {
                            duration: 0
                        },
                        legend: {
                            display: false
                        },
                        scales: {
                            yAxes: [{
                                ticks: {
                                    callback: (value) => {
                                        if(axisType === "linear") {
                                            return value;
                                        }
                                        else if(axisType === "logarithmic") {
                                            // let blockRewardInNim = Evo.Policy.BLOCK_REWARD / Evo.Policy.SATOSHIS_PER_COIN;

                                            let label = Math.round(parseFloat(value) * Evo.Policy.SATOSHIS_PER_COIN) / Evo.Policy.SATOSHIS_PER_COIN;

                                            if(label.toString()[0] !== "1" && label.toString().slice(-1) !== "1") return null;

                                            return label;
                                        }
                                    }
                                },
                                type: axisType,
                                scaleLabel: {
                                    display: true,
                                    labelString: "Balance in NIM",
                                    fontFamily: "'Source Sans Pro', sans-serif",
                                    fontSize: 16
                                }
                            }],
                            xAxes: [{
                                scaleLabel: {
                                    display: true,
                                    labelString: "Accounts (ordered by balance)",
                                    fontFamily: "'Source Sans Pro', sans-serif",
                                    fontSize: 16
                                }
                            }]
                        }
                    }
                });

                $infobox.getElementsByTagName('input')[0].removeAttribute('disabled');
            };

            if(document.getElementById('chart-js-script')) {
                _renderWealthDisributionChart();
            }
            else {
                var scriptTag = document.createElement('script');
                scriptTag.id = "chart-js-script";
                scriptTag.src = "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js";
                scriptTag.onload = _renderWealthDisributionChart;
                document.body.appendChild(scriptTag);
            }
        }

        async function _resolveAccountsTreeNode(currentNode, currentPrefix, balances) {
            if(!currentNode) return;

            currentPrefix += currentNode.prefix;
            if (currentNode.isTerminal()) {
                balances.push(currentNode.account.balance.value);
            }
            else {
                for (const childKey of currentNode.getChildren()) {
                    const node = await $.accounts._tree._store.get(childKey);
                    await _resolveAccountsTreeNode(node, currentPrefix, balances);
                }
            }
        }

        function _wealthDistributionSwitchScale(self) {
            if(self.checked) {
                _wealthDistribution("logarithmic", true);
            }
            else {
                _wealthDistribution("linear", true);
            }
        }
    </script>
    <script>
        async function _globalHashrate() {
            $infobox.innerHTML = tmpl.globalHashrateChart();
            window.scrollTo(0, $infobox.offsetTop - 100);

            // Analyze available path from the beginning, check when difficulty changes
            var difficulty = [];
            var timestamp  = [];

            // Set start time to 24h ago
            var startTime = Math.round(Date.now() / 1000) - 60 * 60 * 24;

            for(var i = 0; i < $.blockchain.path.length; i += Evo.Policy.DIFFICULTY_ADJUSTMENT_BLOCKS) {
                const block = await $.blockchain.getBlock($.blockchain.path[i]);

                if(block.timestamp >= startTime) {
                    difficulty.push(block.difficulty);
                    timestamp.push(block.timestamp);
                }
            }

            // const months = [null, "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

            // Calculate hashrate from difficulty
            var hashrate  = difficulty.map(diff => Math.round(diff * Math.pow(2, 16) / Evo.Policy.BLOCK_TIME));
            var timelabel = timestamp.map(time => {
                let date = new Date(time * 1000);
                return /*date.getDate() + ". " + months[date.getMonth()] + " " + */date.toTimeString().slice(0, 5);
            });

            var _renderGlobalHashrateChart = function() {
                try {
                    $infobox.removeChild($infobox.getElementsByClassName('blocklist-loader')[0]);
                }
                catch(e) {}

                var time = new Date($.blockchain.head.timestamp * 1000);
                $infobox.getElementsByClassName('chart-valid-info')[0].innerHTML = "Created at block #" + $.blockchain.head.height + " - " + time.toLocaleString()

                if(window.chart) window.chart.destroy();
                if(window.chart2) window.chart2.destroy();
                if(window.chart3) window.chart3.destroy();
                if(window.chart4) window.chart4.destroy();

                var ctx = $infobox.getElementsByTagName('canvas')[0].getContext('2d');

                window.chart = new Chart(ctx, {
                    // The type of chart we want to create
                    type: 'line',

                    // The data for our dataset
                    data: {
                        labels: timelabel,
                        datasets: [{
                            label: "Global hashrate",
                            pointBackgroundColor: '#042146',
                            borderColor: '#042146',
                            data: hashrate,
                            steppedLine: 'after'
                        }]
                    },

                    // Configuration options go here
                    options: {
                        legend: {
                            display: false
                        },
                        scales: {
                            yAxes: [{
                                ticks: {
                                    callback: _humanReadableHashesPerSecond
                                },
                                scaleLabel: {
                                    display: true,
                                    labelString: "Hashrate",
                                    fontFamily: "'Source Sans Pro', sans-serif",
                                    fontSize: 16
                                }
                            }]
                        },
                        tooltips: {
                            callbacks: {
                                label: _humanReadableHashesPerSecond
                            }
                        }
                    }
                });
            };

            if(document.getElementById('chart-js-script')) {
                _renderGlobalHashrateChart();
            }
            else {
                var scriptTag = document.createElement('script');
                scriptTag.id = "chart-js-script";
                scriptTag.src = "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js";
                scriptTag.onload = _renderGlobalHashrateChart;
                document.body.appendChild(scriptTag);
            }
        }

        function _humanReadableHashesPerSecond(arg1, arg2) {
            if(typeof arg1 === "number")
                value = arg1;
            else
                value = arg1.yLabel;

            var resultValue = 0;
            var resultUnit = "H/s";

            if(value < 1000) {
                resultValue = value;
            }
            else {
                let kilo = value / 1000;
                if(kilo < 1000) {
                    resultValue = kilo;
                    resultUnit = "kH/s";
                }
                else {
                    let mega = kilo / 1000;
                    if(mega < 1000) {
                        resultValue = mega;
                        resultUnit = "MH/s";
                    }
                    else {
                        resultValue = mega / 1000;
                        resultUnit = "GH/s";
                    }
                }
            }

            if(arg2) {
                resultValue = Math.round(resultValue * 100) / 100;
            }

            return resultValue + " " + resultUnit;
        }
    </script>
    <script>
        async function _transactionsPerBlock() {
            $infobox.innerHTML = tmpl.transactionsPerBlockChart();
            window.scrollTo(0, $infobox.offsetTop - 100);

            var transactionCount = [],
                transactionValue = [],
                height           = [];

            var countAcc = 0,
                valueAcc = 0,
                counter  = 0;

            // Set start time to 24h ago
            var startTime = Math.round(Date.now() / 1000) - 60 * 60 * 24;

            for(var i = 0; i < $.blockchain.path.length; i++) {
                const block = await $.blockchain.getBlock($.blockchain.path[i]);

                if(block.timestamp >= startTime) {
                    counter++;

                    countAcc += block.transactionCount;
                    valueAcc += block.transactions.reduce(function(acc, tx) { return tx.value + acc; }, 0);

                    if(counter >= 10) {
                        transactionCount.push(countAcc);
                        transactionValue.push(valueAcc);
                        height.push((block.height - counter + 1) + "-" + block.height);

                        countAcc = 0;
                        valueAcc = 0;
                        counter  = 0;
                    }
                }
            }

            if(counter > 0) {
                transactionCount.push(countAcc);
                transactionValue.push(valueAcc);
                height.push(($.blockchain.height - counter + 1) + "-" + $.blockchain.height);
            }

            transactionValue = transactionValue.map(value => Evo.Policy.satoshisToCoins(value));

            var _renderTransactionsPerBlockChart = function() {
                try {
                    $infobox.removeChild($infobox.getElementsByClassName('blocklist-loader')[0]);
                }
                catch(e) {}

                var time = new Date($.blockchain.head.timestamp * 1000);
                $infobox.getElementsByClassName('chart-valid-info')[0].innerHTML = "Created at block #" + $.blockchain.head.height + " - " + time.toLocaleString()

                if(window.chart) window.chart.destroy();
                if(window.chart2) window.chart2.destroy();
                if(window.chart3) window.chart3.destroy();
                if(window.chart4) window.chart4.destroy();

                var ctx = $infobox.getElementsByTagName('canvas')[0].getContext('2d');

                window.chart = new Chart(ctx, {
                    // The type of chart we want to create
                    type: 'bar',

                    // The data for our dataset
                    data: {
                        labels: height,
                        datasets: [
                        {
                            label: "Transaction Volume",
                            backgroundColor: '#e34a45',
                            pointBackgroundColor: 'transparent',
                            borderColor: '#e34a45',
                            pointRadius: 3,
                            borderWidth: 2,
                            fill: false,
                            data: transactionValue,
                            type: 'line',
                            yAxisID: 'transactionValue'
                        },
                        {
                            label: "Transactions",
                            backgroundColor: '#042146',
                            borderColor: '#042146',
                            data: transactionCount,
                            yAxisID: 'transactionCount'
                        }]
                    },

                    // Configuration options go here
                    options: {
                        legend: {
                            // display: false
                            reverse: true,
                            labels: {
                                fontFamily: "'Source Sans Pro', sans-serif",
                                fontSize: 16,
                                boxWidth: 16
                            }
                        },
                        scales: {
                            yAxes: [{
                                id: 'transactionCount',
                                position: 'left',
                                scaleLabel: {
                                    display: true,
                                    labelString: "Transactions",
                                    fontFamily: "'Source Sans Pro', sans-serif",
                                    fontSize: 16
                                }
                            },
                            {
                                id: 'transactionValue',
                                position: 'right',
                                scaleLabel: {
                                    display: true,
                                    labelString: "Transaction Volume",
                                    fontFamily: "'Source Sans Pro', sans-serif",
                                    fontSize: 16
                                }
                            }]
                        }
                    }
                });
            };

            if(document.getElementById('chart-js-script')) {
                _renderTransactionsPerBlockChart();
            }
            else {
                var scriptTag = document.createElement('script');
                scriptTag.id = "chart-js-script";
                scriptTag.src = "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js";
                scriptTag.onload = _renderTransactionsPerBlockChart;
                document.body.appendChild(scriptTag);
            }
        }
    </script>
    <script>
        async function _hashingDistribution() {
            $infobox.innerHTML = tmpl.hashingDistributionChart();
            window.scrollTo(0, $infobox.offsetTop - 100);

            var blocksMined24 = {},
                blocksMined12 = {},
                blocksMined2  = {},
                blocksMined1  = {};

            var blocksMined24Sum = 0,
                blocksMined12Sum = 0,
                blocksMined2Sum  = 0,
                blocksMined1Sum  = 0;

            // Set start time to 24h ago
            var startTime24 = Math.round(Date.now() / 1000) - 60 * 60 * 24;
            var startTime12 = Math.round(Date.now() / 1000) - 60 * 60 * 12;
            var startTime2  = Math.round(Date.now() / 1000) - 60 * 60 * 2;
            var startTime1  = Math.round(Date.now() / 1000) - 60 * 60 * 1;

            // Collect data
            for(var i = 0; i < $.blockchain.path.length; i++) {
                const block = await $.blockchain.getBlock($.blockchain.path[i]);

                let address = block.minerAddr.toHex();

                if(block.timestamp >= startTime24) {
                    if(blocksMined24[address]) blocksMined24[address]++;
                    else                       blocksMined24[address] = 1;

                    blocksMined24Sum++;
                }

                if(block.timestamp >= startTime12) {
                    if(blocksMined12[address]) blocksMined12[address]++;
                    else                       blocksMined12[address] = 1;

                    blocksMined12Sum++;
                }

                if(block.timestamp >= startTime2) {
                    if(blocksMined2[address]) blocksMined2[address]++;
                    else                       blocksMined2[address] = 1;

                    blocksMined2Sum++;
                }

                if(block.timestamp >= startTime1) {
                    if(blocksMined1[address]) blocksMined1[address]++;
                    else                       blocksMined1[address] = 1;

                    blocksMined1Sum++;
                }
            }

            // Convert into sortable array
            var blocksMined24Array = [];
            for(address in blocksMined24)
                blocksMined24Array.push({address: address, blocksMined: blocksMined24[address]});

            var blocksMined12Array = [];
            for(address in blocksMined12)
                blocksMined12Array.push({address: address, blocksMined: blocksMined12[address]});

            var blocksMined2Array = [];
            for(address in blocksMined2)
                blocksMined2Array.push({address: address, blocksMined: blocksMined2[address]});

            var blocksMined1Array = [];
            for(address in blocksMined1)
                blocksMined1Array.push({address: address, blocksMined: blocksMined1[address]});

            // Sort by blocksMined
            blocksMined24Array.sort((a, b) => a.blocksMined > b.blocksMined ? -1 : a.blocksMined < b.blocksMined ? 1 : 0);
            blocksMined12Array.sort((a, b) => a.blocksMined > b.blocksMined ? -1 : a.blocksMined < b.blocksMined ? 1 : 0);
            blocksMined2Array.sort((a, b) => a.blocksMined > b.blocksMined ? -1 : a.blocksMined < b.blocksMined ? 1 : 0);
            blocksMined1Array.sort((a, b) => a.blocksMined > b.blocksMined ? -1 : a.blocksMined < b.blocksMined ? 1 : 0);

            // Converting into label and data arrays
            var addresses24 = blocksMined24Array.map(obj => obj.address.substr(0, 20).toUpperCase() + '…');
            var blocksMined24 = blocksMined24Array.map(obj => obj.blocksMined);

            var addresses12 = blocksMined12Array.map(obj => obj.address.substr(0, 20).toUpperCase() + '…');
            var blocksMined12 = blocksMined12Array.map(obj => obj.blocksMined);

            var addresses2 = blocksMined2Array.map(obj => obj.address.substr(0, 20).toUpperCase() + '…');
            var blocksMined2 = blocksMined2Array.map(obj => obj.blocksMined);

            var addresses1 = blocksMined1Array.map(obj => obj.address.substr(0, 20).toUpperCase() + '…');
            var blocksMined1 = blocksMined1Array.map(obj => obj.blocksMined);

            // Filter out the little guys
            var others24 = 0;
            var others24Sum = 0;
            blocksMined24 = blocksMined24.filter(blocksMined => {
                if(blocksMined < 5) {
                    others24 += blocksMined;
                    others24Sum++;
                    return false;
                }
                else
                    return true;
            });

            var others12 = 0;
            var others12Sum = 0;
            blocksMined12 = blocksMined12.filter(blocksMined => {
                if(blocksMined < 3) {
                    others12 += blocksMined;
                    others12Sum++;
                    return false;
                }
                else
                    return true;
            });

            var others2 = 0;
            var others2Sum = 0;
            blocksMined2 = blocksMined2.filter(blocksMined => {
                if(blocksMined < 2) {
                    others2 += blocksMined;
                    others2Sum++;
                    return false;
                }
                else
                    return true;
            });

            // Adapt labels
            addresses24 = addresses24.slice(0, blocksMined24.length);
            addresses24.push(others24Sum + ' others');

            addresses12 = addresses12.slice(0, blocksMined12.length);
            addresses12.push(others12Sum + ' others');

            addresses2  = addresses2.slice(0, blocksMined2.length);
            addresses2.push(others2Sum + ' others');

            // Add blockMined by other to data
            blocksMined24.push(others24);
            blocksMined12.push(others12);
            blocksMined2.push(others2);

            // Convert into percentages
            blocksMined24 = blocksMined24.map(blocksMined => Math.round(blocksMined / blocksMined24Sum * 10000) / 100);
            blocksMined12 = blocksMined12.map(blocksMined => Math.round(blocksMined / blocksMined12Sum * 10000) / 100);
            blocksMined2  = blocksMined2.map(blocksMined => Math.round(blocksMined / blocksMined2Sum * 10000) / 100);
            blocksMined1  = blocksMined1.map(blocksMined => Math.round(blocksMined / blocksMined1Sum * 10000) / 100);


            var _renderHashingDistributionChart = function() {
                try {
                    $infobox.querySelector('.hashing-distribution-chart-wrapper').removeChild($infobox.getElementsByClassName('blocklist-loader')[0]);
                }
                catch(e) {}

                var time = new Date($.blockchain.head.timestamp * 1000);
                $infobox.getElementsByClassName('chart-valid-info')[0].innerHTML = "Created at block #" + $.blockchain.head.height + " - " + time.toLocaleString()

                if(window.chart) window.chart.destroy();
                if(window.chart2) window.chart2.destroy();
                if(window.chart3) window.chart3.destroy();
                if(window.chart4) window.chart4.destroy();

                var ctxs = $infobox.getElementsByTagName('canvas')

                var ctx  = ctxs[0].getContext('2d'),
                    ctx2 = ctxs[1].getContext('2d'),
                    ctx3 = ctxs[2].getContext('2d'),
                    ctx4 = ctxs[3].getContext('2d');

                window.chart = new Chart(ctx, {
                    // The type of chart we want to create
                    type: 'doughnut',

                    // The data for our dataset
                    data: {
                        labels: addresses1,
                        datasets: [
                        {
                            label: "Blocks mined",
                            data: blocksMined1,
                            backgroundColor: default_colors
                        }]
                    },

                    // Configuration options go here
                    options: {
                        title: {
                            display: true,
                            text: 'Last 1 hour'.toUpperCase(),
                            fontFamily: "'Source Sans Pro', sans-serif",
                            fontSize: 16
                        },
                        legend: {
                            display: false
                        }
                    }
                });

                window.chart2 = new Chart(ctx2, {
                    // The type of chart we want to create
                    type: 'doughnut',

                    // The data for our dataset
                    data: {
                        labels: addresses2,
                        datasets: [
                        {
                            label: "Blocks mined",
                            data: blocksMined2,
                            backgroundColor: (() => { var c = default_colors.slice(); c[blocksMined2.length - 1] = Chart.defaults.global.defaultColor; return c })()
                        }]
                    },

                    // Configuration options go here
                    options: {
                        title: {
                            display: true,
                            text: 'Last 2 hours'.toUpperCase(),
                            fontFamily: "'Source Sans Pro', sans-serif",
                            fontSize: 16
                        },
                        legend: {
                            display: false
                        }
                    }
                });

                window.chart3 = new Chart(ctx3, {
                    // The type of chart we want to create
                    type: 'doughnut',

                    // The data for our dataset
                    data: {
                        labels: addresses12,
                        datasets: [
                        {
                            label: "Blocks mined",
                            data: blocksMined12,
                            backgroundColor:  (() => { var c = default_colors.slice(); c[blocksMined12.length - 1] = Chart.defaults.global.defaultColor; return c })()
                        }]
                    },

                    // Configuration options go here
                    options: {
                        title: {
                            display: true,
                            text: 'Last 12 hours'.toUpperCase(),
                            fontFamily: "'Source Sans Pro', sans-serif",
                            fontSize: 16
                        },
                        legend: {
                            display: false
                        }
                    }
                });

                window.chart4 = new Chart(ctx4, {
                    // The type of chart we want to create
                    type: 'doughnut',

                    // The data for our dataset
                    data: {
                        labels: addresses24,
                        datasets: [
                        {
                            label: "Blocks mined",
                            data: blocksMined24,
                            backgroundColor:  (() => { var c = default_colors.slice(); c[blocksMined24.length - 1] = Chart.defaults.global.defaultColor; return c })()
                        }]
                    },

                    // Configuration options go here
                    options: {
                        title: {
                            display: true,
                            text: 'Last 24 hours'.toUpperCase(),
                            fontFamily: "'Source Sans Pro', sans-serif",
                            fontSize: 16
                        },
                        legend: {
                            display: false
                        }
                    }
                });
            };

            if(document.getElementById('chart-js-script')) {
                _renderHashingDistributionChart();
            }
            else {
                var scriptTag = document.createElement('script');
                scriptTag.id = "chart-js-script";
                scriptTag.src = "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js";
                scriptTag.onload = _renderHashingDistributionChart;
                document.body.appendChild(scriptTag);
            }
        }
    </script>
</body>
</html>
